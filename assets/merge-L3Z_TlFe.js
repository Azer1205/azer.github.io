import{B as A}from"./Button-Btf5IT0s.js";import{B as H}from"./board-cUXRfnSF.js";import{p as M}from"./tools-DJurenHp.js";import{d as I,j as m,c as E,h as L,o as q,a as F,f as w,t as N,m as P,w as J,k as K,_ as Q}from"./index-C2FjaYkJ.js";const R={class:"game"},U={class:"score"},W={class:"remaining-steps"},Z={class:"operate",style:{"margin-top":"24px"}},ee=I({__name:"merge",setup(te){const h=m(4),p=m(4),D=[1,2,3,4,5,6,7,8],b=[8,7,6,5,4,3,2,1],c=m([]),O=E(()=>{const t=[];for(let o=0;o<h.value;o++)for(let e=0;e<p.value;e++)t.push(`${o}_${e}`);return t}),S=E(()=>c.value.map(o=>`${o.y}_${o.x}`)),V=E(()=>O.value.filter(t=>!S.value.includes(t))),B=()=>{_.value=!0,x.value=!1,y.value=0,v.value=20,c.value=[];for(let t=0;t<h.value;t++)for(let o=0;o<p.value;o++)T({x:o,y:t},t*p.value+o);setTimeout(()=>{$()},150)};L(B);const j=()=>{let t=Math.ceil(Math.random()*36),o=0;for(;t>0;)t-=D[o],o++;return b[o-1]},T=({x:t,y:o,realY:e},s)=>{const a=`${Date.now().toString(16)}${s?"_"+s:""}`,r=j(),l=m({id:a,x:t,y:o,realY:e,num:r});c.value.push(l.value)},$=()=>{Y();const t={};c.value.forEach(e=>{const s=k(e);s&&s.length>2&&s[0].link&&(t[s[0].link]=s)});const o=Object.keys(t).map(e=>t[e]);if(!o||!o.length){_.value=!1,v.value<=0&&(x.value=!0,M());return}o.forEach(e=>{const s=e.length;let a=0,r=[];e.forEach(u=>{const{y:n}=u;n>a?(a=n,r=[u]):n===a&&r.push(u)});let l={x:0,y:0,num:0};if(r.length===1)l=r[0];else{let u=1;const n=[];e.forEach(i=>{const{x:f}=i,d=n.filter(z=>z.x===f)[0];d?(d.count++,u=Math.max(u,d.count)):n.push({x:f,count:1})});const g=n.filter(i=>i.count>=u);if(g.length>1){r.sort((f,d)=>f.x-d.x);const i=Math.floor(r.length/2);l=r[i]}else{const i=g[0].x;l=r.find(f=>f.x===i)||{x:0,y:0,num:0}}}setTimeout(()=>{if(l.id){let u=0;e.forEach(n=>{n.id!==l.id&&(n.x=l.x,n.y=l.y,n.discard=!0,u+=n.num)}),l.num+=s-2,y.value+=u+l.num,v.value+=s-3}},150)}),setTimeout(()=>{C()},600)},k=(t,o=1)=>{let e=[t];const{x:s,y:a,num:r,id:l,link:u}=t;return[[s,a-1],[s,a+1],[s-1,a],[s+1,a]].forEach(([n,g])=>{const i=c.value.find(f=>f.x===n&&f.y===g);i&&!i.link&&i.num===r&&(t.link=u||l,i.link=u||l,e=[...e,...k(i,o+1)])}),e},x=m(!1),y=m(0),v=m(0),Y=()=>{c.value.forEach(t=>{delete t.link})},C=()=>{c.value=c.value.filter(t=>!t.discard),c.value.forEach(t=>delete t.link),setTimeout(G,150)},G=()=>{const t=[];c.value.forEach(e=>{const{x:s}=e;t[s]||(t[s]=[]),t[s].push(e)}),t.forEach(e=>{e.sort((s,a)=>a.y-s.y),e.forEach((s,a)=>{s.y=h.value-1-a})});const o={};V.value.forEach((e,s)=>{const[a,r]=e.split("_"),l=`y_${a}`;o[l]?o[l]++:o[l]=1,T({x:Number(r),y:0-o[`y_${a}`],realY:Number(a)},s)}),setTimeout(()=>{c.value.forEach(e=>{(e.realY||e.realY===0)&&(e.y=e.realY,delete e.realY)}),setTimeout($,150)},150)},_=m(!1),X=({x:t,y:o})=>{if(x.value||_.value)return;_.value=!0,v.value--,Y();const e=c.value.find(s=>s.x===t&&s.y===o);if(e){let s=0;e.num++;const a=k(e),r=a.length;r>2?setTimeout(()=>{const{x:l,y:u}=e;a.forEach(n=>{n.id!==n.link&&(n.x=l,n.y=u,n.discard=!0,s+=n.num)}),e.num+=r-2,y.value+=s+e.num,v.value+=r-3,setTimeout(C,150)},150):(v.value<=0&&(x.value=!0,M()),C())}};return(t,o)=>(q(),F("div",R,[w("div",U,"分数："+N(y.value),1),w("div",W,"剩余步数: "+N(v.value),1),P(H,{cards:c.value,rows:h.value,cols:p.value,formatter:e=>Math.pow(2,e),onDrop:X},null,8,["cards","rows","cols","formatter"]),w("div",Z,[P(A,{class:"button",type:"warning",size:"small",onClick:B},{default:J(()=>[K("新游戏")]),_:1})])]))}}),le=Q(ee,[["__scopeId","data-v-24c2f089"]]);export{le as default};
