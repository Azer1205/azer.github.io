import{B as V}from"./board-BM61UKu_.js";import{d as X,r as d,h as k,g as A,o as H,c as I,a as C,t as L,j as O,_ as q}from"./index-CiY8X3GU.js";const z={class:"game"},F={class:"score"},G=X({__name:"merge",setup(J){const v=d(4),p=d(4),Y=[1,2,3,4,5,6,7,8],w=[8,7,6,5,4,3,2,1],u=d([]),M=k(()=>{const t=[];for(let s=0;s<v.value;s++)for(let e=0;e<p.value;e++)t.push(`${s}_${e}`);return t}),N=k(()=>u.value.map(s=>`${s.y}_${s.x}`)),P=k(()=>M.value.filter(t=>!N.value.includes(t))),E=()=>{x.value=!0,m.value=0,u.value=[];for(let t=0;t<v.value;t++)for(let s=0;s<p.value;s++)T({x:s,y:t},t*p.value+s);setTimeout(()=>{$()},150)};A(E);const b=()=>{let t=Math.ceil(Math.random()*36),s=0;for(;t>0;)t-=Y[s],s++;return w[s-1]},T=({x:t,y:s,realY:e},o)=>{const l=`${Date.now().toString(16)}${o?"_"+o:""}`,c=b(),a=d({id:l,x:t,y:s,realY:e,num:c});u.value.push(a.value)},m=d(0),$=()=>{B();const t={};u.value.forEach(e=>{const o=g(e);o&&o.length>2&&o[0].link&&(t[o[0].link]=o)});const s=Object.keys(t).map(e=>t[e]);if(!s||!s.length){x.value=!1;return}s.forEach(e=>{const o=e.length;let l=0,c=[];e.forEach(r=>{const{y:n}=r;n>l?(l=n,c=[r]):n===l&&c.push(r)});let a={x:0,y:0,num:0};if(c.length===1)a=c[0];else{let r=1;const n=[];e.forEach(i=>{const{x:f}=i,h=n.filter(S=>S.x===f)[0];h?(h.count++,r=Math.max(r,h.count)):n.push({x:f,count:1})});const y=n.filter(i=>i.count>=r);if(y.length>1){c.sort((f,h)=>f.x-h.x);const i=Math.floor(c.length/2);a=c[i]}else{const i=y[0].x;a=c.find(f=>f.x===i)||{x:0,y:0,num:0}}}setTimeout(()=>{if(a.id){let r=0;e.forEach(n=>{n.id!==a.id&&(n.x=a.x,n.y=a.y,n.discard=!0,r+=n.num)}),a.num+=o-2,m.value+=r+a.num}},150)}),setTimeout(()=>{_()},600)},g=(t,s=1)=>{let e=[t];const{x:o,y:l,num:c,id:a,link:r}=t;return[[o,l-1],[o,l+1],[o-1,l],[o+1,l]].forEach(([n,y])=>{const i=u.value.find(f=>f.x===n&&f.y===y);i&&!i.link&&i.num===c&&(t.link=r||a,i.link=r||a,e=[...e,...g(i,s+1)])}),e},B=()=>{u.value.forEach(t=>{delete t.link})},_=()=>{u.value=u.value.filter(t=>!t.discard),u.value.forEach(t=>delete t.link),setTimeout(D,150)},D=()=>{const t=[];u.value.forEach(e=>{const{x:o}=e;t[o]||(t[o]=[]),t[o].push(e)}),t.forEach(e=>{e.sort((o,l)=>l.y-o.y),e.forEach((o,l)=>{o.y=v.value-1-l})});const s={};P.value.forEach((e,o)=>{const[l,c]=e.split("_"),a=`y_${l}`;s[a]?s[a]++:s[a]=1,T({x:Number(c),y:0-s[`y_${l}`],realY:Number(l)},o)}),setTimeout(()=>{u.value.forEach(e=>{(e.realY||e.realY===0)&&(e.y=e.realY,delete e.realY)}),setTimeout($,150)},150)},x=d(!1),j=({x:t,y:s})=>{if(x.value)return;x.value=!0,B();const e=u.value.find(o=>o.x===t&&o.y===s);if(e){let o=0;e.num++;const l=g(e),c=l.length;c>2?setTimeout(()=>{const{x:a,y:r}=e;l.forEach(n=>{n.id!==n.link&&(n.x=a,n.y=r,n.discard=!0,o+=n.num)}),e.num+=c-2,console.log(o,e.num,m.value),m.value+=o+e.num,console.log(m.value),setTimeout(_,150)},150):_()}};return(t,s)=>(H(),I("div",z,[C("div",F,"分数："+L(m.value),1),O(V,{cards:u.value,rows:v.value,cols:p.value,formatter:e=>Math.pow(2,e),onDrop:j},null,8,["cards","rows","cols","formatter"]),C("div",{class:"operate",style:{"margin-top":"24px"}},[C("button",{class:"button",onClick:E},"重置")])]))}}),R=q(G,[["__scopeId","data-v-d73fd8ad"]]);export{R as default};
